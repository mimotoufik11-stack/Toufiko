---
const { placeholder = 'Search the libraryâ€¦' } = Astro.props;
const inputId = `search-${Math.random().toString(36).slice(2, 8)}`;
const resultsId = `${inputId}-results`;
---
<div class="relative">
  <label for={inputId} class="sr-only">
    Search the Salafi Science Network
  </label>
  <input
    id={inputId}
    type="search"
    placeholder={placeholder}
    class="w-full rounded-2xl border border-primary/10 bg-[var(--color-muted)]/70 px-4 py-3 text-sm text-[var(--color-text)] shadow-sm transition focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40 dark:bg-slate-900/60"
    autocomplete="off"
  />
  <div
    id={resultsId}
    class="absolute left-0 top-full z-40 mt-2 hidden w-full overflow-hidden rounded-2xl border border-primary/10 bg-[var(--color-surface)] shadow-xl"
    role="listbox"
  ></div>
</div>

<script type="module">
  import Fuse from 'fuse.js';
  import searchEntries from '@scripts/search-data';

  const input = document.getElementById({JSON.stringify(inputId)});
  const resultsPanel = document.getElementById({JSON.stringify(resultsId)});

  if (input && resultsPanel) {
    const fuse = new Fuse(searchEntries, {
      includeScore: true,
      threshold: 0.35,
      ignoreLocation: true,
      keys: ['title', 'description', 'tags']
    });

    const renderResults = (items) => {
      if (!items.length) {
        resultsPanel.classList.add('hidden');
        resultsPanel.innerHTML = '';
        return;
      }

      resultsPanel.innerHTML = `
        <ul class="divide-y divide-primary/10">
          ${items
            .slice(0, 6)
            .map(
              (item) => `
                <li>
                  <a href="${item.item.url}" class="block px-4 py-3 transition hover:bg-primary/10">
                    <p class="text-sm font-semibold text-[var(--color-text)]">${item.item.title}</p>
                    <p class="mt-1 text-xs text-[var(--color-text)]/70">${item.item.description}</p>
                  </a>
                </li>
              `
            )
            .join('')}
        </ul>
      `;
      resultsPanel.classList.remove('hidden');
    };

    const handleInput = (event) => {
      const query = event.target.value.trim();
      if (!query) {
        resultsPanel.classList.add('hidden');
        resultsPanel.innerHTML = '';
        return;
      }

      const matches = fuse.search(query);
      renderResults(matches);
    };

    input.addEventListener('input', handleInput);
    input.addEventListener('focus', (event) => {
      if (event.target.value.trim()) {
        const matches = fuse.search(event.target.value.trim());
        renderResults(matches);
      }
    });

    document.addEventListener('click', (event) => {
      if (!resultsPanel.contains(event.target) && event.target !== input) {
        resultsPanel.classList.add('hidden');
      }
    });
  }
</script>
